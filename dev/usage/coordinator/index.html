
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.2, mkdocs-material-8.5.10">
    
    
      
        <title>Plugin coordinator - spiderpool</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.975780f9.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.2505c338.min.css">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#coordinator" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-component="outdated" hidden>
        
          <aside class="md-banner md-banner--warning">
            <div class="md-banner__inner md-grid md-typeset">
              
  You're not viewing the latest version.
  <a href="../../..">
    <strong>Click here to go to latest.</strong>
  </a>

            </div>
            <script>var el=document.querySelector("[data-md-component=outdated]"),outdated=__md_get("__outdated",sessionStorage);!0===outdated&&el&&(el.hidden=!1)</script>
          </aside>
        
      </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="spiderpool" class="md-header__button md-logo" aria-label="spiderpool" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            spiderpool
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Plugin coordinator
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/spidernet-io/spiderpool" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    spidernet-io/spiderpool
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="spiderpool" class="md-nav__button md-logo" aria-label="spiderpool" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    spiderpool
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/spidernet-io/spiderpool" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    spidernet-io/spiderpool
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Spiderpool
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../readme/" class="md-nav__link">
        Get Started
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Installation
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Installation" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Installation
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_1" type="checkbox" id="__nav_3_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3_1">
          Underlay Installation
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Underlay Installation" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_1">
          <span class="md-nav__icon md-icon"></span>
          Underlay Installation
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../install/underlay/get-started-calico/" class="md-nav__link">
        Calico
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../install/underlay/get-started-weave/" class="md-nav__link">
        Weave
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../install/underlay/get-started-kind/" class="md-nav__link">
        Macvlan
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../install/underlay/get-started-ovs/" class="md-nav__link">
        Ovs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../install/underlay/get-started-sriov/" class="md-nav__link">
        SR-IOV
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2" type="checkbox" id="__nav_3_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3_2">
          Overlay Installation
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Overlay Installation" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_2">
          <span class="md-nav__icon md-icon"></span>
          Overlay Installation
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../install/overlay/get-started-calico/" class="md-nav__link">
        Calico
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../install/overlay/get-started-cilium/" class="md-nav__link">
        Cilium
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_3" type="checkbox" id="__nav_3_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3_3">
          Public Cloud Installation
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Public Cloud Installation" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_3">
          <span class="md-nav__icon md-icon"></span>
          Public Cloud Installation
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../install/cloud/get-started-alibaba/" class="md-nav__link">
        Alibaba Cloud
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../install/cloud/get-started-vmware/" class="md-nav__link">
        VWware vSphere
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../install/cloud/get-started-openstack/" class="md-nav__link">
        OpenStack
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../install/upgrade/" class="md-nav__link">
        Upgrading
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Usage
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Usage" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Usage
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../spider-multus-config/" class="md-nav__link">
        SpiderMultusConfig
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ippool-namespace/" class="md-nav__link">
        IPAM of IPPool Namespace
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../spider-affinity/" class="md-nav__link">
        IPAM of IPPool Affinity
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ippool-multi/" class="md-nav__link">
        IPAM of Backup IPPool
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../spider-subnet/" class="md-nav__link">
        IPAM of SpiderSubnet
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../third-party-controller/" class="md-nav__link">
        IPAM for custom controllers
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../statefulset/" class="md-nav__link">
        IPAM for StatefulSet
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../reserved-ip/" class="md-nav__link">
        IPAM of Reserved IP
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../multi-interfaces-annotation/" class="md-nav__link">
        MultipleInterfaces
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../egress/" class="md-nav__link">
        Egress Policy
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ipv6/" class="md-nav__link">
        IPv6 Support
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../route/" class="md-nav__link">
        Route Support
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../service/" class="md-nav__link">
        Service Support
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Plugin coordinator
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Plugin coordinator
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#resolve-the-problem-of-underlay-pods-unable-to-access-clusterip" class="md-nav__link">
    Resolve the problem of underlay Pods unable to access ClusterIP
  </a>
  
    <nav class="md-nav" aria-label="Resolve the problem of underlay Pods unable to access ClusterIP">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configure-coordinator-to-run-in-underlay-networks" class="md-nav__link">
    Configure coordinator to run in underlay networks
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure-coordinator-to-run-in-overlay-networks" class="md-nav__link">
    Configure coordinator to run in overlay networks
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#detect-pod-ip-conflicts" class="md-nav__link">
    Detect Pod IP conflicts
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#detect-pod-gateway-reachability" class="md-nav__link">
    Detect Pod gateway reachability
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fix-mac-address-prefix-for-pods" class="md-nav__link">
    Fix MAC address prefix for Pods
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#known-issues" class="md-nav__link">
    Known issues
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ifacer/" class="md-nav__link">
        Plugin ifacer
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../network-topology/" class="md-nav__link">
        Node-based Topology
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../rdma/" class="md-nav__link">
        RDMA
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubevirt/" class="md-nav__link">
        Kubevirt
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../debug/" class="md-nav__link">
        FAQ
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          Concepts
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Concepts" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Concepts
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/arch/" class="md-nav__link">
        Architecture
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/ipam/" class="md-nav__link">
        IPAM
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/ipam-performance/" class="md-nav__link">
        IPAM Performance
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/io-performance/" class="md-nav__link">
        I/O Performance
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/blog/" class="md-nav__link">
        Blogs
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          Reference
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Reference" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Reference
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/annotation/" class="md-nav__link">
        Annotations
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/configmap/" class="md-nav__link">
        Configmap
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/metrics/" class="md-nav__link">
        Metrics
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/spiderpool-controller/" class="md-nav__link">
        spiderpool-controller
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/spiderpool-agent/" class="md-nav__link">
        spiderpool-agent
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/crd-spidersubnet/" class="md-nav__link">
        CRD SpiderSubnet
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/crd-spiderippool/" class="md-nav__link">
        CRD SpiderIPPool
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/crd-spidermultusconfig/" class="md-nav__link">
        CRD Spidermultusconfig
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/crd-spidercoordinator/" class="md-nav__link">
        CRD Spidercoordinator
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/crd-spiderendpoint/" class="md-nav__link">
        CRD SpiderEndpoint
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/crd-spiderreservedip/" class="md-nav__link">
        CRD SpiderReservedIP
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/plugin-coordinator/" class="md-nav__link">
        Coordinatorr plugin
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/plugin-ifacer/" class="md-nav__link">
        ifacer plugin
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/plugin-ipam/" class="md-nav__link">
        IPAM plugin
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" type="checkbox" id="__nav_7" >
      
      
      
      
        <label class="md-nav__link" for="__nav_7">
          Development
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Development" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          Development
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../develop/contributing/" class="md-nav__link">
        Contribution Guide
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../develop/CODE-OF-CONDUCT/" class="md-nav__link">
        Code of Conduct
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../develop/release/" class="md-nav__link">
        Release workflow
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../develop/roadmap/" class="md-nav__link">
        Roadmap
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../develop/swagger_openapi/" class="md-nav__link">
        Swagger OpenAPI
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#resolve-the-problem-of-underlay-pods-unable-to-access-clusterip" class="md-nav__link">
    Resolve the problem of underlay Pods unable to access ClusterIP
  </a>
  
    <nav class="md-nav" aria-label="Resolve the problem of underlay Pods unable to access ClusterIP">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configure-coordinator-to-run-in-underlay-networks" class="md-nav__link">
    Configure coordinator to run in underlay networks
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure-coordinator-to-run-in-overlay-networks" class="md-nav__link">
    Configure coordinator to run in overlay networks
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#detect-pod-ip-conflicts" class="md-nav__link">
    Detect Pod IP conflicts
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#detect-pod-gateway-reachability" class="md-nav__link">
    Detect Pod gateway reachability
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fix-mac-address-prefix-for-pods" class="md-nav__link">
    Fix MAC address prefix for Pods
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#known-issues" class="md-nav__link">
    Known issues
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  
  



  <a href="https://github.com/spidernet-io/spiderpool/edit/master/docs/usage/coordinator.md" title="Edit this page" class="md-content__button md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>


<h1 id="coordinator">Coordinator</h1>
<p><strong>English</strong> | <a href="../coordinator-zh_CN/"><strong>简体中文</strong></a></p>
<p>Spiderpool incorporates a CNI meta-plugin called <code>coordinator</code> that works after the Main CNI is invoked. It mainly offers the following features:</p>
<ul>
<li>Resolve the problem of underlay Pods unable to access ClusterIP</li>
<li>Coordinate the routing for Pods with multiple NICs, ensuring consistent packet paths</li>
<li>Detect IP conflicts within Pods</li>
<li>Check the reachability of Pod gateways</li>
<li>Support fixed Mac address prefixes for Pods</li>
</ul>
<p>Let's delve into how coordinator implements these features.</p>
<blockquote>
<p>You can configure <code>coordinator</code> by specifying all the relevant fields in <code>SpinderMultusConfig</code> if a NetworkAttachmentDefinition CR is created via <code>SpinderMultusConfig CR</code>. For more information, please refer to <a href="../../reference/crd-spidermultusconfig/">SpinderMultusConfig</a>.</p>
<p><code>Spidercoordinators CR</code> serves as the global default configuration (all fields) for <code>coordinator</code>. However, this configuration has a lower priority compared to the settings in the NetworkAttachmentDefinition CR. In cases where no configuration is provided in the NetworkAttachmentDefinition CR, the values from <code>Spidercoordinators CR</code> serve as the defaults. For detailed information, please refer to <a href="../../reference/crd-spidercoordinator/">Spidercoordinator</a>.</p>
</blockquote>
<h2 id="resolve-the-problem-of-underlay-pods-unable-to-access-clusterip">Resolve the problem of underlay Pods unable to access ClusterIP</h2>
<p>When using underlay CNIs like Macvlan, IPvlan, SR-IOV, and others, a common challenge arises where underlay pods are unable to access ClusterIP. This occurs because accessing ClusterIP from underlay pods requires routing through the gateway on the switch. However, in many instances, the gateway is not configured with the proper routes to reach the ClusterIP, leading to restricted access.</p>
<h3 id="configure-coordinator-to-run-in-underlay-networks">Configure <code>coordinator</code> to run in underlay networks</h3>
<blockquote>
<p>By default, the value of mode is set to auto (specified as spec.mode in the <code>Spidercoordinator CR</code>). In this configuration, <code>coordinator</code> will check if the current CNI network interface is <code>eth0</code>. If it is, <code>coordinator</code> identifies itself as operating in the underlay mode.
If the current network interface is not <code>eth0</code>, <code>coordinator</code> further checks if the Pod has a <code>veth0</code> network interface. If <code>veth0</code> exists,  <code>coordinator</code> identifies itself as operating in the underlay mode.</p>
</blockquote>
<p>When your businesses are deployed in a "traditional network" or IAAS environment, the IP addresses of the Pods can be directly assigned from the host machine's IP subnet. This enables the Pods to use their own IP addresses for both east-west and north-south communication.</p>
<p>This mode offers several advantages:</p>
<ul>
<li>Avoid interference from NAT mappings, allowing the Pods to maintain their original IP addresses</li>
<li>Leverage underlying network devices for access control over Pods</li>
<li>Enhance the performance of Pod network communication by eliminating the need for tunneling technologies</li>
</ul>
<p>When Pods access east-west traffic (ClusterIP) within the cluster, the traffic is initially routed to the local host. The host then uses its own IP address to reach the target Pod. This process may involve three-layer hops through external routers. Therefore, it is crucial to ensure proper layer 3 network connectivity.</p>
<p>To resolve this issue, you can configure <code>coordinator</code> to operate in underlay networks. In this mode, <code>coordinator</code> creates a Veth pair, with one end placed on the host and the other within the Pod's network namespace. Furthermore, routing rules are set within the Pod, enabling traffic forwarding via the veth device when accessing ClusterIP. And Traffic is forwarded via eth0 or net1 interfaces for external destinations outside the cluster.</p>
<p><img alt="underlay" src="../../images/spiderpool-underlay.jpg" /></p>
<p>Here are some examples:</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8s.cni.cncf.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NetworkAttachmentDefinition</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">macvlan-underlay</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-system</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">config</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|-</span>
<span class="w">    </span><span class="no">{</span>
<span class="w">        </span><span class="no">&quot;cniVersion&quot;: &quot;0.3.1&quot;,</span>
<span class="w">        </span><span class="no">&quot;name&quot;: &quot;macvlan-underlay&quot;,</span>
<span class="w">        </span><span class="no">&quot;plugins&quot;: [</span>
<span class="w">            </span><span class="no">{</span>
<span class="w">                </span><span class="no">&quot;type&quot;: &quot;macvlan&quot;,</span>
<span class="w">                </span><span class="no">&quot;master&quot;: &quot;ens160&quot;,</span>
<span class="w">                </span><span class="no">&quot;mode&quot;: &quot;bridge&quot;,</span>
<span class="w">                </span><span class="no">&quot;ipam&quot;: {</span>
<span class="w">                    </span><span class="no">&quot;type&quot;: &quot;spiderpool&quot;</span>
<span class="w">                </span><span class="no">}</span>
<span class="w">            </span><span class="no">},{</span>
<span class="w">                </span><span class="no">&quot;type&quot;: &quot;coordinator&quot;,</span>
<span class="w">                </span><span class="no">&quot;mode&quot;: &quot;underlay&quot;</span>
<span class="w">            </span><span class="no">}</span>
<span class="w">        </span><span class="no">]</span>
<span class="w">    </span><span class="no">}</span>
</code></pre></div>
<p>mode: the operating mode of <code>coordinator</code>. It defaults to auto mode. With the annotation <code>v1.multus-cni.io/default-network: kube-system/macvlan-underlay</code> written into the Pod, <code>coordinator</code> will automatically determine the mode as underlay.</p>
<p>Let's view the routing information and other details of the Pod created through the macvlan-underlay configuration:</p>
<div class="highlight"><pre><span></span><code>root@controller:~#<span class="w"> </span>kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>macvlan-underlay-5496bb9c9b-c7rnp<span class="w"> </span>sh
kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span><span class="o">[</span>POD<span class="o">]</span><span class="w"> </span><span class="o">[</span>COMMAND<span class="o">]</span><span class="w"> </span>is<span class="w"> </span>DEPRECATED<span class="w"> </span>and<span class="w"> </span>will<span class="w"> </span>be<span class="w"> </span>removed<span class="w"> </span><span class="k">in</span><span class="w"> </span>a<span class="w"> </span>future<span class="w"> </span>version.<span class="w"> </span>Use<span class="w"> </span>kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span><span class="o">[</span>POD<span class="o">]</span><span class="w"> </span>--<span class="w"> </span><span class="o">[</span>COMMAND<span class="o">]</span><span class="w"> </span>instead.
<span class="c1">#</span>
<span class="c1"># ip a show veth0</span>
<span class="m">5</span>:<span class="w"> </span>veth0@if428513:<span class="w"> </span>&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;<span class="w"> </span>mtu<span class="w"> </span><span class="m">1500</span><span class="w"> </span>qdisc<span class="w"> </span>noqueue<span class="w"> </span>state<span class="w"> </span>UP<span class="w"> </span>group<span class="w"> </span>default
<span class="w">    </span>link/ether<span class="w"> </span>4a:fe:19:22:65:05<span class="w"> </span>brd<span class="w"> </span>ff:ff:ff:ff:ff:ff<span class="w"> </span>link-netnsid<span class="w"> </span><span class="m">0</span>
<span class="w">    </span>inet6<span class="w"> </span>fe80::48fe:19ff:fe22:6505/64<span class="w"> </span>scope<span class="w"> </span>link
<span class="w">       </span>valid_lft<span class="w"> </span>forever<span class="w"> </span>preferred_lft<span class="w"> </span>forever
<span class="c1"># ip r</span>
default<span class="w"> </span>via<span class="w"> </span><span class="m">10</span>.6.0.1<span class="w"> </span>dev<span class="w"> </span>eth0
<span class="m">10</span>.6.0.0/16<span class="w"> </span>dev<span class="w"> </span>eth0<span class="w"> </span>proto<span class="w"> </span>kernel<span class="w"> </span>scope<span class="w"> </span>link<span class="w"> </span>src<span class="w"> </span><span class="m">10</span>.6.212.241
<span class="m">10</span>.6.212.101<span class="w"> </span>dev<span class="w"> </span>veth0<span class="w"> </span>scope<span class="w"> </span>link
<span class="m">10</span>.233.64.0/18<span class="w"> </span>via<span class="w"> </span><span class="m">10</span>.6.212.101<span class="w"> </span>dev<span class="w"> </span>veth0
</code></pre></div>
<ul>
<li><strong>10.6.212.101 dev veth0 scope link</strong>: 10.6.212.101 represents the IP address of the node, ensuring that traffic from the Pod to the node is forwarded through <code>veth0</code>.</li>
<li><strong>10.233.64.0/18 via 10.6.212.101 dev veth0</strong>: 10.233.64.0/18 represents the CIDR for the cluster's Service, ensuring that traffic from the Pod to ClusterIP is forwarded through <code>veth0</code>.</li>
</ul>
<p>This solution heavily relies on kube-proxy's MASQUERADE. In some specific scenarios, it may be necessary to set <code>masqueradeAll</code> to true in the kube-proxy configuration.</p>
<blockquote>
<p>By default, the underlay subnet of Pods is different from the cluster's clusterCIDR, so there is no need to enable <code>masqueradeAll</code>. Traffic between them will go through SNAT. However, if the underlay subnet of Pods matches the cluster's clusterCIDR, <code>masqueradeAll</code> must be set to true.</p>
</blockquote>
<h3 id="configure-coordinator-to-run-in-overlay-networks">Configure <code>coordinator</code> to run in overlay networks</h3>
<p>In contrast to the underlay mode, there are scenarios whose aim is just to enable the cluster to run on most underlying networks instead of specifying the network the cluster deploy in. This can be achieved by utilizing CNIs such as <a href="https://github.com/projectcalico/calico">Calico</a> and <a href="https://github.com/cilium/cilium">Cilium</a>. These CNI plugins often leverage tunneling technologies like VXLAN to establish an overlay network plane and implement NAT for north-south communication.</p>
<blockquote>
<p>By default, the mode is set to auto (specified as auto in the spec.mode field of spidercoordinator CR). <code>coordinator</code> automatically determines the mode based on the current interface. If the interface that CNI invokes is not <code>eth0</code> and then there is no <code>veth0</code> within the Pod, <code>coordinator</code> identifies it as running in the overlay mode.</p>
</blockquote>
<p>This mode offers several advantages:</p>
<ul>
<li>Abundant IP addresses mitigates concerns about IP scarcity</li>
<li>Strong compatibility with on a wide range of underlying networks</li>
</ul>
<p>However, there are some challenges to consider:</p>
<ul>
<li>Performance may be impacted due to the encapsulation techniques used by Calico.</li>
<li>Most overlay solutions do not support fixed IP addresses for Pods.</li>
<li>When attaching multiple interfaces to a Pod using Multus, communication between Pods may encounter issues with inconsistent packet routing paths, thus disrupting normal communication.</li>
</ul>
<blockquote>
<p>With multiple NICs, Pod often encounter inconsistent packet routing paths. This can be problematic if there are security devices along the data path, as the inconsistent routes may cause the traffic to be perceived as a "half-connection" (lacking TCP SYN packet records but receiving TCP ACK packets). In such cases, security devices may block the connection, resulting in disrupted communication.</p>
</blockquote>
<p>We can configure <code>coordinator</code> to run in the overlay mode to address this issue. In this mode, <code>coordinator</code> does not create veth devices but instead implements policy-based routing. This ensures that when Pods access ClusterIP, the traffic is forwarded through <code>eth0</code> (typically created by CNIs like Calico or Cilium), while traffic directed towards external destinations from Pods is routed through <code>net1</code> (usually created by CNIs like Macvlan or IPvlan).</p>
<blockquote>
<p>In the overlay mode, Spiderpool automatically synchronizes the Pod subnet of the cluster's default CNI. These subnets are utilized to configure routing within Pods with multiple interfaces, ensuring smooth communication between Pods using the default CNI through <code>eth0</code>. The configuration is specified by <code>spidercoordinator.spec.podCIDRType</code>, which defaults to <code>auto</code> and supports other options including ["calico", "cilium", "cluster", "none"].</p>
<p>These routing configurations are injected during Pod startup and do not apply automatically to running Pods if there are changes in the associated CIDRs, unless restarting the Pods.</p>
<p>Refer to <a href="../../reference/crd-spidercoordinator/">CRD-Spidercoordinator</a> for more information</p>
</blockquote>
<p><img alt="overlay" src="../../images/spiderpool-overlay.jpg" /></p>
<p>Here is an example:</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8s.cni.cncf.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NetworkAttachmentDefinition</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">macvlan-overlay</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-system</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">config</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|-</span>
<span class="w">    </span><span class="no">{</span>
<span class="w">        </span><span class="no">&quot;cniVersion&quot;: &quot;0.3.1&quot;,</span>
<span class="w">        </span><span class="no">&quot;name&quot;: &quot;macvlan-overlay&quot;,</span>
<span class="w">        </span><span class="no">&quot;plugins&quot;: [</span>
<span class="w">            </span><span class="no">{</span>
<span class="w">                </span><span class="no">&quot;type&quot;: &quot;macvlan&quot;,</span>
<span class="w">                </span><span class="no">&quot;master&quot;: &quot;ens160&quot;,</span>
<span class="w">                </span><span class="no">&quot;mode&quot;: &quot;bridge&quot;,</span>
<span class="w">                </span><span class="no">&quot;ipam&quot;: {</span>
<span class="w">                    </span><span class="no">&quot;type&quot;: &quot;spiderpool&quot;</span>
<span class="w">                </span><span class="no">}</span>
<span class="w">            </span><span class="no">},{</span>
<span class="w">                </span><span class="no">&quot;type&quot;: &quot;coordinator&quot;,</span>
<span class="w">                </span><span class="no">&quot;mode&quot;: &quot;overlay&quot;</span>
<span class="w">            </span><span class="no">}</span>
<span class="w">        </span><span class="no">]</span>
<span class="w">    </span><span class="no">}</span>
</code></pre></div>
<p>mode: the operating mode of <code>coordinator</code>. It defaults to auto mode. With the annotation <code>k8s.v1.cni.cncf.io/networks: kube-system/macvlan-overlay</code> written into the Pod, <code>coordinator</code> will automatically determine the mode as overlay.</p>
<p>Let's view the routing information and other details of the Pod created through the macvlan-overlay configuration:</p>
<div class="highlight"><pre><span></span><code>root@controller:~#<span class="w"> </span>kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>macvlan-overlay-97bf89fdd-kdgrb<span class="w"> </span>sh
kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span><span class="o">[</span>POD<span class="o">]</span><span class="w"> </span><span class="o">[</span>COMMAND<span class="o">]</span><span class="w"> </span>is<span class="w"> </span>DEPRECATED<span class="w"> </span>and<span class="w"> </span>will<span class="w"> </span>be<span class="w"> </span>removed<span class="w"> </span><span class="k">in</span><span class="w"> </span>a<span class="w"> </span>future<span class="w"> </span>version.<span class="w"> </span>Use<span class="w"> </span>kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span><span class="o">[</span>POD<span class="o">]</span><span class="w"> </span>--<span class="w"> </span><span class="o">[</span>COMMAND<span class="o">]</span><span class="w"> </span>instead.
<span class="c1">#</span>
<span class="c1"># ip rule</span>
<span class="m">0</span>:<span class="w"> </span>from<span class="w"> </span>all<span class="w"> </span>lookup<span class="w"> </span><span class="nb">local</span>
<span class="m">32759</span>:<span class="w"> </span>from<span class="w"> </span><span class="m">10</span>.233.105.154<span class="w"> </span>lookup<span class="w"> </span><span class="m">100</span>
<span class="m">32761</span>:<span class="w"> </span>from<span class="w"> </span>all<span class="w"> </span>to<span class="w"> </span><span class="m">169</span>.254.1.1<span class="w"> </span>lookup<span class="w"> </span><span class="m">100</span>
<span class="m">32762</span>:<span class="w"> </span>from<span class="w"> </span>all<span class="w"> </span>to<span class="w"> </span><span class="m">10</span>.233.64.0/18<span class="w"> </span>lookup<span class="w"> </span><span class="m">100</span>
<span class="m">32763</span>:<span class="w"> </span>from<span class="w"> </span>all<span class="w"> </span>to<span class="w"> </span><span class="m">10</span>.233.0.0/18<span class="w"> </span>lookup<span class="w"> </span><span class="m">100</span>
<span class="m">32765</span>:<span class="w"> </span>from<span class="w"> </span>all<span class="w"> </span>to<span class="w"> </span><span class="m">10</span>.6.212.102<span class="w"> </span>lookup<span class="w"> </span><span class="m">100</span>
<span class="m">32766</span>:<span class="w"> </span>from<span class="w"> </span>all<span class="w"> </span>lookup<span class="w"> </span>main
<span class="m">32767</span>:<span class="w"> </span>from<span class="w"> </span>all<span class="w"> </span>lookup<span class="w"> </span>default
<span class="c1"># ip r</span>
default<span class="w"> </span>via<span class="w"> </span><span class="m">10</span>.6.0.1<span class="w"> </span>dev<span class="w"> </span>net1
<span class="m">10</span>.6.0.0/16<span class="w"> </span>dev<span class="w"> </span>net1<span class="w"> </span>proto<span class="w"> </span>kernel<span class="w"> </span>scope<span class="w"> </span>link<span class="w"> </span>src<span class="w"> </span><span class="m">10</span>.6.212.227
<span class="c1"># ip r show table 100</span>
default<span class="w"> </span>via<span class="w"> </span><span class="m">169</span>.254.1.1<span class="w"> </span>dev<span class="w"> </span>eth0
<span class="m">10</span>.6.212.102<span class="w"> </span>dev<span class="w"> </span>eth0<span class="w"> </span>scope<span class="w"> </span>link
<span class="m">10</span>.233.0.0/18<span class="w"> </span>via<span class="w"> </span><span class="m">10</span>.6.212.102<span class="w"> </span>dev<span class="w"> </span>eth0
<span class="m">10</span>.233.64.0/18<span class="w"> </span>via<span class="w"> </span><span class="m">10</span>.6.212.102<span class="w"> </span>dev<span class="w"> </span>eth0
<span class="m">169</span>.254.1.1<span class="w"> </span>dev<span class="w"> </span>eth0<span class="w"> </span>scope<span class="w"> </span>link
</code></pre></div>
<p>Policy-based routes:</p>
<ul>
<li><strong>32759: from 10.233.105.154 lookup 100</strong>: packets from <code>eth0</code> (Calico network interface) are routed through table 100</li>
<li><strong>32762: from all to 10.233.64.0/18 lookup 100</strong>: when The traffic of Pods accessing ClusterIP is routed through table 100 via <code>eth0</code></li>
<li>By default, all subnet routes for net1 are preserved in the Main table, while subnet routes for <code>eth0</code> are maintained in table 100.</li>
</ul>
<p>In the overlay mode, Pods accessing ClusterIP rely solely on the overlay CNI's NIC (<code>eth0</code>) without any additional configurations.</p>
<h2 id="detect-pod-ip-conflicts">Detect Pod IP conflicts</h2>
<p>During Pod creation, <code>coordinator</code> can be utilized to detect IP conflicts, supporting both IPv4 and IPv6 addresses. This is accomplished by sending ARP or NDP probe packets and confirming if the MAC address in the response packet is the same as the Pod's one. If a mismatch is found, it indicates an IP conflict.</p>
<p>To enable this feature, the following configuration can be done:</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8s.cni.cncf.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NetworkAttachmentDefinition</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">macvlan-underlay</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-system</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">config</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|-</span>
<span class="w">    </span><span class="no">{</span>
<span class="w">        </span><span class="no">&quot;cniVersion&quot;: &quot;0.3.1&quot;,</span>
<span class="w">        </span><span class="no">&quot;name&quot;: &quot;macvlan-underlay&quot;,</span>
<span class="w">        </span><span class="no">&quot;plugins&quot;: [</span>
<span class="w">            </span><span class="no">{</span>
<span class="w">                </span><span class="no">&quot;type&quot;: &quot;macvlan&quot;,</span>
<span class="w">                </span><span class="no">&quot;master&quot;: &quot;ens160&quot;,</span>
<span class="w">                </span><span class="no">&quot;mode&quot;: &quot;bridge&quot;,</span>
<span class="w">                </span><span class="no">&quot;ipam&quot;: {</span>
<span class="w">                    </span><span class="no">&quot;type&quot;: &quot;spiderpool&quot;</span>
<span class="w">                </span><span class="no">}</span>
<span class="w">            </span><span class="no">},{</span>
<span class="w">                </span><span class="no">&quot;type&quot;: &quot;coordinator&quot;,</span>
<span class="w">                </span><span class="no">&quot;mode&quot;: &quot;underlay&quot;,</span>
<span class="w">                </span><span class="no">&quot;detectGateway&quot;: false,</span>
<span class="w">                </span><span class="no">&quot;detectIPConflict&quot;: true</span>
<span class="w">            </span><span class="no">}</span>
<span class="w">        </span><span class="no">]</span>
<span class="w">    </span><span class="no">}</span>
</code></pre></div>
<p>If an IP conflict is detected, the creation of the Pod will fail. The event logs for the Pod will indicate the physical address of the host with the conflicting IP.</p>
<h2 id="detect-pod-gateway-reachability">Detect Pod gateway reachability</h2>
<p>During Pod creation, <code>coordinator</code> can verify the reachability of the Pod's gateway, supporting both IPv4 and IPv6 gateway addresses. This is accomplished by sending ICMP packets to probe the accessibility of the gateway address.</p>
<p>Enable this feature through the following configuration:</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8s.cni.cncf.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NetworkAttachmentDefinition</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">macvlan-underlay</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-system</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">config</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|-</span>
<span class="w">    </span><span class="no">{</span>
<span class="w">        </span><span class="no">&quot;cniVersion&quot;: &quot;0.3.1&quot;,</span>
<span class="w">        </span><span class="no">&quot;name&quot;: &quot;macvlan-underlay&quot;,</span>
<span class="w">        </span><span class="no">&quot;plugins&quot;: [</span>
<span class="w">            </span><span class="no">{</span>
<span class="w">                </span><span class="no">&quot;type&quot;: &quot;macvlan&quot;,</span>
<span class="w">                </span><span class="no">&quot;master&quot;: &quot;ens160&quot;,</span>
<span class="w">                </span><span class="no">&quot;mode&quot;: &quot;bridge&quot;,</span>
<span class="w">                </span><span class="no">&quot;ipam&quot;: {</span>
<span class="w">                    </span><span class="no">&quot;type&quot;: &quot;spiderpool&quot;</span>
<span class="w">                </span><span class="no">}</span>
<span class="w">            </span><span class="no">},{</span>
<span class="w">                </span><span class="no">&quot;type&quot;: &quot;coordinator&quot;,</span>
<span class="w">                </span><span class="no">&quot;mode&quot;: &quot;underlay&quot;,</span>
<span class="w">                </span><span class="no">&quot;detectGateway&quot;: true</span>
<span class="w">            </span><span class="no">}</span>
<span class="w">        </span><span class="no">]</span>
<span class="w">    </span><span class="no">}</span>
</code></pre></div>
<p>If the Pod's gateway is unreachable, the creation of the Pod will fail. The event logs for the Pod will indicate related errors.</p>
<h2 id="fix-mac-address-prefix-for-pods">Fix MAC address prefix for Pods</h2>
<p><code>coordinator</code> allows to set a fixed MAC address prefix for Pods. The MAC address of each Pod will be generated by a combination of the configured MAC address prefix and the Pod's IP.</p>
<p>Enable this feature through the following configuration:</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8s.cni.cncf.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NetworkAttachmentDefinition</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">macvlan-underlay</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-system</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">config</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|-</span>
<span class="w">    </span><span class="no">{</span>
<span class="w">        </span><span class="no">&quot;cniVersion&quot;: &quot;0.3.1&quot;,</span>
<span class="w">        </span><span class="no">&quot;name&quot;: &quot;macvlan-underlay&quot;,</span>
<span class="w">        </span><span class="no">&quot;plugins&quot;: [</span>
<span class="w">            </span><span class="no">{</span>
<span class="w">                </span><span class="no">&quot;type&quot;: &quot;macvlan&quot;,</span>
<span class="w">                </span><span class="no">&quot;master&quot;: &quot;ens160&quot;,</span>
<span class="w">                </span><span class="no">&quot;mode&quot;: &quot;bridge&quot;,</span>
<span class="w">                </span><span class="no">&quot;ipam&quot;: {</span>
<span class="w">                    </span><span class="no">&quot;type&quot;: &quot;spiderpool&quot;</span>
<span class="w">                </span><span class="no">}</span>
<span class="w">            </span><span class="no">},{</span>
<span class="w">                </span><span class="no">&quot;type&quot;: &quot;coordinator&quot;,</span>
<span class="w">                </span><span class="no">&quot;mode&quot;: &quot;underlay&quot;,</span>
<span class="w">                </span><span class="no">&quot;podMACPrefix&quot;: &quot;0a:1b&quot;</span>
<span class="w">            </span><span class="no">}</span>
<span class="w">        </span><span class="no">]</span>
<span class="w">    </span><span class="no">}</span>
</code></pre></div>
<p>You can check if the MAC address prefix of the Pod starts with "0a:1b" after a Pod is created.</p>
<h2 id="known-issues">Known issues</h2>
<ul>
<li>
<p>Underlay mode: TCP communication between underlay Pods and overlay Pods (Calico or Cilium) fails</p>
<p>This issue arises from inconsistent packet routing paths. Request packets are matched with the routing on the source Pod side and forwarded through veth0 to the host side. And then the packets are further forwarded to the target Pod. The target Pod perceives the source IP of the packet as the underlay IP of the source Pod, allowing it to bypass the source Pod's host and directly route through the underlay network. However, on the host, this is considered an invalid packet (as it receives unexpected TCP SYN-ACK packets that are conntrack table invalid), explicitly dropping it using an iptables rule in kube-proxy. Switching the kube-proxy mode to ipvs can address this issue.</p>
</li>
<li>
<p>Overlay mode: with Cilium as the default CNI and multiple NICs for the Pod, the underlay interface of the Pod cannot communicate with the node.</p>
<p>Macvlan interfaces do not allow direct communication between parent and child interfaces in bridge mode in most cases. To facilitate communication between the underlay IP of the Pod and the node, we rely on the default CNI to create Veth devices. However, Cilium restricts the forwarding of IPs from non-Cilium subnets through these Veth devices.</p>
</li>
</ul>





                
              </article>
            </div>
          
          
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </a>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../service/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Service Support" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Service Support
            </div>
          </div>
        </a>
      
      
        
        <a href="../ifacer/" class="md-footer__link md-footer__link--next" aria-label="Next: Plugin ifacer" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Plugin ifacer
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.top", "navigation.tracking", "search.highlight", "search.suggest", "search.share"], "search": "../../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.5a2dcb6a.min.js"></script>
      
    
    
  </body>
</html>